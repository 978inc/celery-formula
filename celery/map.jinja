{% from "celery/defaults.yaml" import lookup_map, default_config as dc with context %}

{% set _grains = salt['grains.get']('celery:lookup', {}) %}
{% set _pillar = salt['pillar.get']('celery:lookup', _grains, merge=True) %}

{% set celery = salt['grains.filter_by'](lookup_map, merge=_pillar, base='default')  %}

{% set config = {
  'broker': salt['pillar.get']('celery:config:broker', dc.broker, merge=True),
	'task': salt['pillar.get']('celery:config:task', dc.task, merge=True),
	'worker': salt['pillar.get']('celery:config:worker', dc.worker, merge=True)
	} %}

{% do celery.update({'config': config}) %}
