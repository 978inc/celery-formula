#!jinja
# This file is managed by Saltstack, any changes will be overwritten!!
{% from "celery/map.jinja" import celery with context -%}

{% set queue_names = [] %}
{% for i in celery['worker_queues'] %}
{% do queue_names.append(i.get('name', 'default')) %}
{% endfor %}

{% set prefix = celery.prefix -%}
{% if celery.bin_env != '/usr' -%}
{% set prefix = celery.bin_env -%}
{% endif %}

{% set cmd = "%s/bin/celery" % prefix -%}
{% set FLAGS = [
  "--pidfile={{ celery.run_dir }}/{{ celery.service }}-%n.pid"
  "--loglevel={{ celery.log_level }}",
  "--logfile={{ celery.log_dir }}/{{ celery.service }}-%n%I.log",
  "--statedb={{ celery.run_dir }}/{{ celery.service }}/%n.state "
  ]|join(" ") -%}

[Unit]
Description=Celery Worker Daemon - {{ service_name|upper|replace("-", "_") }}
After=network-online.target
Wants=network-online.target

[Service]
Type=forking
{%- with workers = queue_config.keys()|join(' ') %}
User={{ user|default('celery') }}
Group={{ user|default('celery')  }}
EnvironmentFile=/etc/default/{{ service_name }}
WorkingDirectory={{ working_dir }}/

ExecStart=/bin/sh -c '{{ cmd }} multi start {{ queue_names|join(" ") }}  {{ celeryd_opts }} \
--pidfile={{ celery.run_dir }}/{{ celery.service }}-%n.pid \
--loglevel={{ celery.log_level }} \
--logfile={{ celery.log_dir }}/{{ celery.service }}-%n%I.log \
--statedb={{ celery.run_dir }}/%n.state \
--workdir={{ working_dir }} \
--config={{ celery.config_module }}'

ExecStop=/bin/sh -c '{{ cmd }} multi stopwait {{ queue_names|join(" ") }}  --pidfile={{ celery.run_dir }}/{{ celery.service }}-%n.pid '
{% endwith %}

[Install]
WantedBy=multi-user.target
